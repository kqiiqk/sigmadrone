<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="SigmaDrone Flight Deck">
  <meta name="author" content="SigmaDrone Developers">
  <link rel="icon" href="./images/logo.ico">

  <title>SigmaDrone Flight Deck</title>

  <!-- Bootstrap core CSS -->
  <link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="./css/main.css" rel="stylesheet">

</head>

<body>
  <div class="container">
    <div class="header">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#home"><img alt="SigmaDrone" src="./images/logo.svg" height="45"></a>
          </div>
          <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav nav-pills">
              <li class="active"><a href="#home" data-toggle="tab">Home</a></li>
              <li><a href="#control" data-toggle="tab"><span class="glyphicon glyphicon-wrench"></span> Configure</a></li>
            </ul>
          </div> <!-- navbar-collapse-->
        </div><!-- container-fluid -->
      </nav>
    </div><!-- header -->

    <hr class="featurette-divider">

    <div class="tab-content main">

      <div id="home" class="tab-pane fade in active">
        <div class="row">
          <div class="col-xs-4">Attitude</div>
          <div class="col-xs-3"></div>
          <div class="col-xs-5">&#x26a1<span id="battery_percent">100</span>%</div>
        </div>
        <div class="row">
          <div class="col-xs-11 col-data attitude"><span id="attQ">w:1.000 x:0.000 y:0.000 z:0.000</span></div>
        </div>
        <div class="row row-padded">
          <div class="col-xs-12">
            <div class="row"> <div class="col-xs-11">Altitude</div> </div>
            <div class="row"> <div class="col-xs-10 col-data"><span id="altitude">100</span> m</div> </div>
          </div>
        </div>
        <div class="row row-padded">
          <div class="col-xs-12">
            <div class="row"> <div class="col-xs-11">Speed</div> </div>
            <div class="row"> <div class="col-xs-10 col-data"><span id="gps-speed">0</span> km/h</div> </div>
          </div>
        </div>

        <hr class="featurette-divider">  

        <div class="row row-padded sensors">
          <a href="#sensors-id" id="sensors-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Sensors
          </a>
          <div id="sensors-id" class="col-xs-12 col-data collapse">
            <div class="row row-padded"> <div class="col-xs-11">Accelerometer</div> </div>
            <div class="row"> 
              <div class="col-xs-11 col-data"><span id="accel">x:0.000 y:0.000 z:1.000</span></div> 
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Gyroscope, deg/s</div> </div>
            <div class="row"> 
              <div class="col-xs-11 col-data"><span id="gyro">x:0.000 y:0.000 z:0.000</span></div> 
            </div>
            <div class="row row-padded"> <div class="col-xs-11">Magnetometer</div> </div>
            <div class="row"> 
              <div class="col-xs-11 col-data"><span id="mag">x:0.000 y:0.000 z:0.000</span></div> 
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#motors-id" id="motors-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>Motors
          </a>
          <div id = "motors-id" class="col-xs-12 collapse">
            <div class="row"> 
              <div class="col-md-2 col-xs-5 col-data">M4: <span id="motor4">50</span> %</div> 
              <div class="col-md-2 col-xs-5">M3: <span id="motor3">50</span> %</div> 
            </div>
            <div class="row"> 
              <div class="col-md-2 col-xs-5 col-data">M1: <span id="motor2">50</span> %</div> 
              <div class="col-md-2 col-xs-5">M2: <span id="motor1">50</span> %</div> 
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#gps-id" id="gps-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>GPS
          </a>
          <div id = "gps-id" class="col-xs-12 collapse">
            <div class="row"> 
              <div class="col-md-2 col-xs-4 col-data">Latitude:</div> 
              <div class="col-md-4 col-xs-6 col"><span id="gps-lat">45.00</span> deg</div> 
            </div>
            <div class="row"> 
              <div class="col-md-2 col-xs-4 col-data">Longitude:</div> 
              <div class="col-md-4 col-xs-6 col"><span id="gps-long">-112.00</span> deg</div> 
            </div>
            <div class="row"> 
              <div class="col-md-2 col-xs-4 col-data">SAT Count:</div> 
              <div class="col-md-4 col-xs-6 col"><span id="gps-satellites">3</span></div> 
            </div>
            <div class="row"> 
              <div class="col-md-2 col-xs-4 col-data">Course:</div> 
              <div class="col-md-4 col-xs-6 col"><span id="gps-satellites">360</span> deg</div> 
            </div>
            <div class="row"> 
              <div class="col-md-2 col-xs-4 col-data">Altitude:</div> 
              <div class="col-md-4 col-xs-6 col"><span id="gps-altitude">0</span> m</div> 
            </div>
          </div>
        </div>

        <hr class="featurette-divider">  

      </div> <!--div id="home" class="container tab-pane fade in active"-->

      <div id="control" class="tab-pane fade">
        <div class="row row-padded">
          <a href="#pidxy-id" id="pidxy-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>PID Controller XY
          </a>
          <div id = "pidxy-id" class="col-xs-12 collapse">
            <form class="form-horizontal" role="form" id="pidxy-form" onsubmit="return onPidXYSubmit();">
              <div class="form-group" aria-invalid="true">
                <div class="col-xs-4 col-md-2">
                  <label for="kp-xy">Kp</label>
                  <input id="kp-xy" name="kp-xy" class="form-control input-sm" type="number" min="0.0" max="0.2" step="0.001" required="true">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-xy">Ki</label>
                  <input id="ki-xy" name="ki-xy" class="form-control input-sm" type="number" min="0.0" max="0.2" step="0.001" required="true">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="kd-xy">Kd</label>
                  <input id="kd-xy" name="kd-xy" class="form-control input-sm" type="number" min="0.0" max="0.2" step="0.001" required="true">
                </div>
              </div>
              <div class="form-group">        
                <div class="col-sm-offset-2 col-sm-10">
                  <button type="submit" class="btn btn-default" id="pidxy-apply-btn">Apply</button>
                </div>
              </div>
            </form>
          </div> <!--div class=row-->
        </div> <!--div class="row row-padded"-->

        <hr class="featurette-divider">

        <div class="row row-padded">
          <a href="#pidz-id" id="pidz-btn" class="btn btn-link" data-toggle="collapse">
            <span class="glyphicon glyphicon-triangle-right"></span>PID Controller Z
          </a>
          <div id = "pidz-id" class="col-xs-12 collapse">
            <div class="row">
              <div class="form-group">
                <div class="col-xs-4 col-md-2">
                  <label for="kp-z">Kp</label>
                  <input id="kp-z" name="kp-z" class="form-control input-sm" type="number" min="0.0" max="0.2" step="0.001">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="ki-z">Ki</label>
                  <input id="ki-z" name="ki-z" class="form-control input-sm" type="number" min="0.0" max="0.2" step="0.001">
                </div>
                <div class="col-xs-4 col-md-2">
                  <label for="kd-z">Kd</label>
                  <input id="kd-z" name="kd-z" class="form-control input-sm" type="number" min="0.0" max="0.2" step="0.001">
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr class="featurette-divider">

      </div> <!--div id="control" class="container tab-pane fade"-->

    </div> <!--div class="tab-content"-->


    <footer class="footer">
      <p>
        &copy; Sigmadrone 2015
      </p>
    </footer>

  </div><!-- container -->

   <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="./jquery/jquery-2.1.1.min.js"></script>
  <script src="./bootstrap/js/bootstrap.min.js"></script>


  <script>
  var id = 0;

  function rpcCall(url, method, params, successCallback, failCallback) {
    var request = {id: ++id, jsonrpc: "2.0"};
    request.method = method;
    request.params = params;
    if (request.params.length > 0) {
      request.params = JSON.parse(request.params);
    }
    console.log(JSON.stringify(request));
    $.post(url, JSON.stringify(request), successCallback, "json").fail(failCallback);
  }

  function quaternion2str(q) {
    return 'w:' + q.w.toFixed(3) + ' x:' + q.x.toFixed(3) + '  y:' + q.y.toFixed(3) + '  z:' + q.z.toFixed(3);
  }

  function vector2str(v) {
    return 'x:' + v[0].toFixed(3) + ' y:' + v[1].toFixed(3) + ' z:' + v[2].toFixed(3);
  } 
  
  function updateDroneState(response) {
    if (response.error != null) {
      console.log(JSON.stringify(response.result)); 
    } else {
      $("#attQ").text(quaternion2str(response.result.attitude));
      $("#accel").text(vector2str(response.result.accel));
      $("#gyro").text(vector2str(response.result.gyro));
      $("#mag").text(vector2str(response.result.mag));
      $("#altitude").text(response.result.altitude_meters.toFixed(2));
      $("#motor1").text(response.result.motors[0].toFixed(3));
      $("#motor2").text(response.result.motors[1].toFixed(3));
      $("#motor3").text(response.result.motors[2].toFixed(3));
      $("#motor4").text(response.result.motors[3].toFixed(3));
      $("#battery").text(response.result.battery_voltage.toFixed(2));
      $("#battery_percent").text(response.result.battery_percentage.toFixed(2));
      $("#temperature_val").text(response.result.temperature.toFixed(1) + ' ');
      $("#gps-lat").text(response.result.gps_latitude);
      $("#gps-long").text(response.result.gps_longitude); 
      $("#gps-satelites").text(response.result.gps_satellites);
      if (response.result.gps_satellites > 5) {
        $("#gps-speed").text(response.result.gps_speed_kmph.toFixed(1));
        $("#gps-course").text(response.result.gps_course_deg.toFixed(2));
        $("#gps-course").text(response.result.gps_altitude.toFixed(2));
      } else {
        $("#gps-speed").text('0');
        $("#gps-course").text( 'N/A');
      }
      $("#dt").text(response.result.dt/1000);
    }
  }

  function toggleCollapsable(collapseId, buttonId, spanText) {
    $(collapseId).on("hide.bs.collapse", function(){
      $(buttonId).html('<span class="glyphicon glyphicon-triangle-right"></span> ' + spanText);
    });
    $(collapseId).on("show.bs.collapse", function(){
      $(buttonId).html('<span class="glyphicon glyphicon-triangle-bottom"></span> ' + spanText);
    });
  }

  $(document).ready(function() {
    toggleCollapsable("#sensors-id", "#sensors-btn", "Sensors");
    toggleCollapsable("#motors-id", "#motors-btn", "Motors");
    toggleCollapsable("#gps-id", "#gps-btn", "GPS");
    toggleCollapsable("#pidxy-id", "#pidxy-btn", "PID Controller XY");
    toggleCollapsable("#pidz-id", "#pidz-btn", "PID Controller Z");
  });

  var url = "http://10.10.10.1:18222/firmware";


  function getDroneState() {
    rpcCall(url, "sd_get_dronestate_ex", JSON.parse("[]"), updateDroneState);
  }

  function onPidXYSubmit() {
    var $myForm = $('#pidxy-form');
    if (!$myForm[0].checkValidity()) {
      return true;
    }
    rpcCall(url, "kp", "[" + $myForm[0].elements['kp-xy'].value + "]");
    rpcCall(url, "ki", "[" + $myForm[0].elements['ki-xy'].value + "]");
    rpcCall(url, "kd", "[" + $myForm[0].elements['kd-xy'].value + "]");
    $myForm.find(':submit').blur();
    return false;
  }

  window.setInterval(getDroneState, 500);

  </script>

  </body>
  </html>
